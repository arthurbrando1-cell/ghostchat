<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostChat Ultra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0b141a; --bg-panel: #111b21; --bg-sidebar: #202c33;
            --accent: #00a884; --text: #e9edef; --msg-me: #005c4b; --danger: #f15c6d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR E LISTAS */
        .sidebar { width: 350px; background: var(--bg-panel); border-right: 1px solid #2f3b43; display: flex; flex-direction: column; }
        .header-tools { padding: 10px 15px; background: var(--bg-sidebar); display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #222d34; position: relative; }
        .chat-item:hover { background: #2a3942; }
        .online-dot { width: 12px; height: 12px; background: #06d755; border-radius: 50%; border: 2px solid var(--bg-panel); position: absolute; left: 45px; bottom: 10px; }

        /* CHAT PRINCIPAL */
        .main-content { flex: 1; display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded51.png'); }
        .chat-header { padding: 10px 20px; background: var(--bg-sidebar); display: flex; align-items: center; gap: 15px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }

        /* BUBBLES */
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 65%; font-size: 14px; position: relative; }
        .msg.me { align-self: flex-end; background: var(--msg-me); }
        .msg.other { align-self: flex-start; background: var(--bg-sidebar); }
        .msg img, .msg video { max-width: 100%; border-radius: 5px; margin-top: 5px; }

        /* INPUT AREA */
        .input-area { padding: 10px; background: var(--bg-sidebar); display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; background: #2a3942; border: none; padding: 10px; border-radius: 20px; color: white; outline: none; }
        
        /* EMOJI PICKER */
        .emoji-box { position: absolute; bottom: 70px; left: 20px; background: var(--bg-sidebar); width: 300px; height: 200px; overflow-y: auto; display: none; grid-template-columns: repeat(6, 1fr); padding: 10px; border-radius: 10px; border: 1px solid var(--accent); }
        .emoji-box span { cursor: pointer; font-size: 20px; padding: 5px; }

        /* PERFIL ESTILO DISCORD */
        .profile-card { width: 100%; background: #18191c; border-radius: 8px; overflow: hidden; position: relative; }
        .banner { height: 100px; background-size: cover; background-position: center; background-color: var(--accent); }
        .pfp-large { width: 80px; height: 80px; border-radius: 50%; border: 6px solid #18191c; margin-top: -40px; margin-left: 20px; position: relative; }

        /* MODAIS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-content { background: var(--bg-panel); padding: 20px; border-radius: 12px; width: 400px; max-height: 80vh; overflow-y: auto; }
        
        /* BOTÃ•ES */
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-green { background: var(--accent); color: white; }
        .btn-record { background: #ea4335; color: white; border-radius: 50%; width: 40px; height: 40px; }
        .recording { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header-tools">
            <img src="" id="my-avatar" class="btn" style="width:40px; height:40px; border-radius:50%" onclick="openProfile()">
            <div>
                <button onclick="openModal('modal-status')"><i class="fa-solid fa-circle-notch"></i></button>
                <button onclick="openModal('modal-group')"><i class="fa-solid fa-users"></i></button>
                <button onclick="openModal('modal-search')"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="main-content">
        <div class="chat-header" id="chat-header" style="display:none">
            <img src="" id="header-img" style="width:40px; height:40px; border-radius:50%">
            <div style="flex:1">
                <h4 id="header-name">Nome</h4>
                <small id="header-status">online</small>
            </div>
            <div id="group-admin-tools" style="display:none">
                <button onclick="editGroup()"><i class="fa-solid fa-gear"></i></button>
            </div>
            <button onclick="blockUser()" id="btn-block" style="color:var(--danger)"><i class="fa-solid fa-ban"></i></button>
        </div>

        <div id="messages"></div>

        <div class="emoji-box" id="emoji-picker"></div>

        <div class="input-area">
            <button onclick="toggleEmojis()"><i class="fa-regular fa-face-smile"></i></button>
            <label for="file-up"><i class="fa-solid fa-paperclip"></i></label>
            <input type="file" id="file-up" hidden onchange="handleFileUpload(this)">
            
            <input type="text" id="main-input" placeholder="Mensagem" onkeypress="checkEnter(event)">
            
            <button id="btn-record" class="btn-record"><i class="fa-solid fa-microphone"></i></button>
            <button onclick="sendMsg()" class="btn-green"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="modal-profile" class="modal">
        <div class="modal-content profile-card">
            <div class="banner" id="prof-banner"></div>
            <img src="" class="pfp-large" id="prof-pic">
            <div style="padding: 20px;">
                <input type="text" id="edit-name" placeholder="Nome" style="background:transparent; color:white; border:none; font-size:20px; font-weight:bold; display:block">
                <input type="text" id="edit-bio" placeholder="Sua bio..." style="background:transparent; color:gray; border:none; width:100%; margin-top:10px">
                <hr style="margin:15px 0; opacity:0.1">
                <small>Alterar Banner (URL):</small>
                <input type="text" id="edit-banner-url" style="width:100%; padding:5px; margin-bottom:10px">
                <button class="btn btn-green" onclick="saveProfile()">SALVAR MUDANÃ‡AS</button>
                <button class="btn" onclick="closeModals()">FECHAR</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ImportaÃ§Ãµes Firebase (Auth, Firestore, Storage)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        const firebaseConfig = { /* INSIRA SEU CONFIG AQUI */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let myData = {}, activeChatId = null, isGroup = false, mediaRecorder, audioChunks = [];

        // --- SISTEMA DE LOGIN E PRESENÃ‡A ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { signInAnonymously(auth); return; }
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            
            if (snap.exists()) {
                myData = snap.data();
            } else {
                const id = Math.floor(1000 + Math.random() * 9000);
                myData = { uid: user.uid, ghostId: id.toString(), name: `Ghost#${id}`, bio: "Ghosting...", pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${id}`, banner: "", online: true, blocked: [] };
                await setDoc(userRef, myData);
            }
            updateUI();
            loadChatList();
            setOnlineStatus(true);
        });

        const setOnlineStatus = (status) => {
            updateDoc(doc(db, "users", myData.uid), { online: status, lastSeen: serverTimestamp() });
        };

        // --- EMOJIS ---
        const emojis = "ðŸ˜€ðŸ˜ƒðŸ˜„ðŸ˜ðŸ˜†ðŸ˜…ðŸ˜‚ðŸ¤£ðŸ˜ŠðŸ˜‡ðŸ™‚ðŸ™ƒðŸ˜‰ðŸ˜ŒðŸ˜ðŸ¥°ðŸ˜˜ðŸ˜—ðŸ˜™ðŸ˜šðŸ˜‹ðŸ˜›ðŸ˜œðŸ¤ªðŸ˜ðŸ¤‘ðŸ¤—ðŸ¤­ðŸ¤«ðŸ¤”ðŸ˜ðŸ˜‘ðŸ˜¶ðŸ˜ðŸ˜’ðŸ™„ðŸ˜¬ðŸ¤¥ðŸ˜ŒðŸ˜”ðŸ˜ªðŸ¤¤ðŸ˜´ðŸ˜·ðŸ¤’ðŸ¤•ðŸ¤¢ðŸ¤®ðŸ¤§ðŸ˜µðŸ¤¯ðŸ¤ ðŸ¥³ðŸ˜ŽðŸ¤“ðŸ§ðŸ˜•ðŸ˜ŸðŸ™â˜¹ï¸ðŸ˜®ðŸ˜¯ðŸ˜²ðŸ˜³ðŸ¥ºðŸ˜¦ðŸ˜§ðŸ˜¨ðŸ˜°ðŸ˜¥ðŸ˜¢ðŸ˜­ðŸ˜¤ðŸ˜ ðŸ˜¡ðŸ¤¬ðŸ˜ˆðŸ‘¿ðŸ’€â˜ ï¸ðŸ‘»ðŸ‘½ðŸ¤–ðŸŽƒðŸ‘‹ðŸ¤šâœ‹ðŸ–ï¸âœŒï¸ðŸ¤žðŸ¤ŸðŸ¤˜ðŸ¤™ðŸ‘ŒðŸ¤ŒðŸ¤âœŠðŸ‘ŠðŸ¤›ðŸ¤œðŸ‘ðŸ‘Žâœï¸ðŸ™ŒðŸ‘ðŸ«¶ðŸ™ðŸ’ªðŸ¦¾ðŸ¦¿â¤ï¸ðŸ§¡ðŸ’›ðŸ’šðŸ’™ðŸ’œðŸ–¤ðŸ¤ðŸ¤ŽðŸ’”â£ï¸ðŸ’•ðŸ’žðŸ’“ðŸ’—ðŸ’–ðŸ’˜ðŸ’¯âœ”ï¸âŒâ—â“â•â”âš ï¸ðŸš«â›”ðŸ”žâ­ðŸŒŸâœ¨ðŸ’¥ðŸ”¥ðŸŽ‰ðŸŽŠðŸ˜‚ðŸ¤£ðŸ˜­ðŸ’€ðŸ˜ŽðŸ—¿ðŸ‘€ðŸ’­ðŸ¤¨ðŸ˜³ðŸ‘ðŸ‘Žâ¤ï¸ðŸ”¥ðŸ™ðŸ’¯ðŸ¶ðŸ±ðŸ­ðŸ¹ðŸ°ðŸ¦ŠðŸ»ðŸ¼ðŸ¨ðŸ¯ðŸ¦ðŸ®ðŸ·ðŸ¸ðŸµðŸ”ðŸ§ðŸ¦ðŸ¤ðŸ¦†ðŸ¦…ðŸðŸ¢ðŸŠðŸ¦–ðŸ¦•ðŸŸðŸ ðŸ³ðŸ¬ðŸ¦ˆðŸŽðŸŠðŸŒðŸ‰ðŸ‡ðŸ“ðŸ«ðŸ”ðŸŸðŸ•ðŸŒ­ðŸ¥ªðŸŒ®ðŸŒ¯ðŸðŸœðŸ£ðŸ¤ðŸ—ðŸ–ðŸ°ðŸ§ðŸ©ðŸªðŸ«ðŸ¿â˜•ðŸºðŸ»ðŸ¥¤ðŸ§ƒðŸŽ®ðŸ•¹ï¸ðŸ‘¾ðŸŽ²â™Ÿï¸ðŸ’»ðŸ–¥ï¸âŒ¨ï¸ðŸ–±ï¸ðŸ“±ðŸ“¡ðŸŒâš™ï¸ðŸ”§ðŸ”¨ðŸ’¾ðŸ“‚ðŸ“ðŸ§ ðŸ¤–ðŸš€âœˆï¸ðŸš—ðŸï¸ðŸš²ðŸ ðŸ¢ðŸ™ï¸ðŸ“¦ðŸ“ŒðŸ“ŽðŸ”‘ðŸ”’ðŸ”“ðŸ”ŠðŸ”‡ðŸ””ðŸ§¨ðŸ’£ðŸŒ";
        const picker = document.getElementById('emoji-picker');
        [...emojis].forEach(e => {
            let span = document.createElement('span');
            span.innerText = e;
            span.onclick = () => document.getElementById('main-input').value += e;
            picker.appendChild(span);
        });

        window.toggleEmojis = () => picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid';

        // --- ENVIO DE MENSAGENS ---
        window.checkEnter = (e) => { if(e.key === 'Enter') sendMsg(); };

        window.sendMsg = async (mediaUrl = null, type = 'text') => {
            const input = document.getElementById('main-input');
            if(!input.value && !mediaUrl) return;

            const col = isGroup ? "group_msgs" : "messages";
            await addDoc(collection(db, col), {
                chatId: activeChatId,
                senderId: myData.uid,
                senderName: myData.name,
                content: input.value,
                media: mediaUrl,
                type: type,
                timestamp: serverTimestamp(),
                seen: false
            });
            input.value = "";
        };

        // --- UPLOAD DE ARQUIVOS (IMG/VIDEO) ---
        window.handleFileUpload = async (el) => {
            const file = el.files[0];
            if(!file) return;
            const sRef = ref(storage, `chats/${Date.now()}_${file.name}`);
            const task = await uploadBytes(sRef, file);
            const url = await getDownloadURL(task.ref);
            sendMsg(url, file.type.split('/')[0]); // img, video ou application
        };

        // --- GRAVAÃ‡ÃƒO DE ÃUDIO ---
        const btnRec = document.getElementById('btn-record');
        btnRec.onmousedown = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            btnRec.classList.add('recording');
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        };

        btnRec.onmouseup = () => {
            mediaRecorder.stop();
            btnRec.classList.remove('recording');
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                const sRef = ref(storage, `audios/${Date.now()}.ogg`);
                await uploadBytes(sRef, blob);
                const url = await getDownloadURL(sRef);
                sendMsg(url, 'audio');
            };
        };

        // --- GERENCIAMENTO DE PERFIL ---
        window.openProfile = () => {
            document.getElementById('edit-name').value = myData.name;
            document.getElementById('edit-bio').value = myData.bio;
            document.getElementById('prof-pic').src = myData.pic;
            document.getElementById('prof-banner').style.backgroundImage = `url(${myData.banner})`;
            openModal('modal-profile');
        };

        window.saveProfile = async () => {
            const name = document.getElementById('edit-name').value;
            const bio = document.getElementById('edit-bio').value;
            const banner = document.getElementById('edit-banner-url').value;
            await updateDoc(doc(db, "users", myData.uid), { name, bio, banner });
            location.reload();
        };

        // --- UTILITÃRIOS ---
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

        function updateUI() {
            document.getElementById('my-avatar').src = myData.pic;
        }

        // FunÃ§Ãµes de carregar chats, grupos e status seguem a mesma lÃ³gica de onSnapshot
        // para garantir que tudo seja atualizado em tempo real.
    </script>
</body>
</html>
