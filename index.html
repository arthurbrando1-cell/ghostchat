<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web Clone</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .chat-bg { background-color: #efeae2; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4cfc6' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #374045; border-radius: 3px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .message-out { background-color: #d9fdd3; }
        .message-in { background-color: #ffffff; }
        .message-out::after { content: ''; position: absolute; right: -8px; top: 0; border-width: 8px; border-style: solid; border-color: #d9fdd3 transparent transparent transparent; }
        .message-in::after { content: ''; position: absolute; left: -8px; top: 0; border-width: 8px; border-style: solid; border-color: #ffffff transparent transparent transparent; }
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 60%, 100% { opacity: 0; } 30% { opacity: 1; } }
        .online-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; max-height: 200px; overflow-y: auto; }
        .emoji-btn { font-size: 24px; padding: 4px; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        .emoji-btn:hover { background: #374045; }
    </style>
</head>
<body class="bg-[#111b21] h-screen overflow-hidden">
    <!-- Auth Screen -->
    <div id="authScreen" class="flex items-center justify-center h-screen">
        <div class="bg-[#202c33] p-8 rounded-lg shadow-2xl w-96">
            <div class="flex items-center justify-center mb-6">
                <svg class="w-16 h-16 text-[#00a884]" viewBox="0 0 39 39" fill="currentColor">
                    <path d="M10.7 32.8l.6.3c2.5 1.5 5.3 2.2 8.1 2.2 8.8 0 16-7.2 16-16 0-4.2-1.7-8.3-4.7-11.3s-7-4.7-11.3-4.7c-8.8 0-16 7.2-15.9 16.1 0 3 .9 5.9 2.4 8.4l.4.6-1.6 5.9 6-1.5z"></path>
                    <path fill="#111b21" d="M32.4 6.4C29 2.9 24.3 1 19.5 1 9.3 1 1.1 9.3 1.2 19.4c0 3.2.9 6.3 2.4 9.1L1 38l9.7-2.5c2.7 1.5 5.7 2.2 8.7 2.2 10.1 0 18.3-8.3 18.3-18.4 0-4.9-1.9-9.5-5.3-12.9zM19.5 34.6c-2.7 0-5.4-.7-7.7-2.1l-.6-.3-5.8 1.5L6.9 28l-.4-.6c-1.5-2.4-2.3-5.2-2.3-8 0-8.4 6.8-15.2 15.3-15.2 4.1 0 7.9 1.6 10.8 4.5 2.9 2.9 4.5 6.7 4.5 10.8-.1 8.4-6.9 15.1-15.3 15.1zm8.4-11.3c-.5-.2-2.7-1.3-3.1-1.5-.4-.2-.7-.2-1 .2-.3.5-1.2 1.5-1.5 1.8-.3.3-.5.3-1 .1s-2-0.7-3.8-2.3c-1.4-1.2-2.3-2.8-2.6-3.2-.3-.5 0-.7.2-1 .2-.2.5-.5.7-.8.2-.3.3-.5.5-.8.2-.3.1-.6 0-.8-.1-.2-1-2.4-1.4-3.3-.4-.9-.7-.8-1-.8-.3 0-.6 0-.9 0s-.8.1-1.3.6-1.6 1.6-1.6 3.9 1.7 4.5 1.9 4.8c.2.3 3.3 5 7.9 7 1.1.5 2 .8 2.6 1 1.1.3 2.1.3 2.9.2.9-.1 2.7-1.1 3.1-2.2.4-1.1.4-2 .3-2.2-.1-.2-.4-.3-.9-.5z"></path>
                </svg>
            </div>
            <h1 class="text-2xl font-light text-white text-center mb-6">WhatsApp Web</h1>
            
            <!-- Login Form -->
            <div id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" 
                    class="w-full px-4 py-3 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-400">
                <input type="password" id="loginPassword" placeholder="Senha" 
                    class="w-full px-4 py-3 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-400">
                <button onclick="login()" 
                    class="w-full py-3 bg-[#00a884] text-white rounded-lg hover:bg-[#02906f] transition-colors font-medium">
                    Entrar
                </button>
                <p class="text-center text-[#8696a0]">
                    NÃ£o tem conta? <button onclick="showRegister()" class="text-[#00a884] hover:underline">Registrar</button>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="space-y-4 hidden">
                <input type="text" id="registerName" placeholder="Nome de usuÃ¡rio" 
                    class="w-full px-4 py-3 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-400">
                <input type="email" id="registerEmail" placeholder="Email" 
                    class="w-full px-4 py-3 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-400">
                <input type="password" id="registerPassword" placeholder="Senha (mÃ­n. 6 caracteres)" 
                    class="w-full px-4 py-3 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-400">
                <button onclick="register()" 
                    class="w-full py-3 bg-[#00a884] text-white rounded-lg hover:bg-[#02906f] transition-colors font-medium">
                    Criar conta
                </button>
                <p class="text-center text-[#8696a0]">
                    JÃ¡ tem conta? <button onclick="showLogin()" class="text-[#00a884] hover:underline">Entrar</button>
                </p>
            </div>

            <div id="authError" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-400 text-sm text-center"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden h-screen flex">
        <!-- Left Panel - Chats List -->
        <div id="leftPanel" class="w-[30%] min-w-[300px] bg-[#111b21] flex flex-col border-r border-[#222d34]">
            <!-- Header -->
            <div class="h-14 bg-[#202c33] flex items-center justify-between px-4">
                <div class="flex items-center gap-3 cursor-pointer" onclick="showProfileModal()">
                    <div id="myAvatarHeader" class="w-10 h-10 rounded-full bg-[#6b7175] flex items-center justify-center text-white font-medium overflow-hidden">
                        <img id="myAvatarImg" class="w-full h-full object-cover hidden" />
                        <span id="myAvatarLetter"></span>
                    </div>
                </div>
                <div class="flex items-center gap-5 text-[#aebac1]">
                    <button onclick="showNewChat()" class="hover:text-white" title="Nova conversa">
                        <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                            <path d="M19.005 3.175H4.674C3.642 3.175 3 3.789 3 4.821V21.02l3.544-3.514h12.461c1.033 0 2.064-1.06 2.064-2.093V4.821c-.001-1.032-1.032-1.646-2.064-1.646zm-4.989 9.869H7.041V11.1h6.975v1.944zm3-4H7.041V7.1h9.975v1.944z"></path>
                        </svg>
                    </button>
                    <button onclick="logout()" class="hover:text-white" title="Sair">
                        <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                            <path d="M16 13v-2H7V8l-5 4 5 4v-3z"></path>
                            <path d="M20 3h-9c-1.103 0-2 .897-2 2v4h2V5h9v14h-9v-4H9v4c0 1.103.897 2 2 2h9c1.103 0 2-.897 2-2V5c0-1.103-.897-2-2-2z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="p-2 bg-[#111b21]">
                <div class="flex items-center bg-[#202c33] rounded-lg px-4 py-2">
                    <svg viewBox="0 0 24 24" class="w-5 h-5 text-[#8696a0]" fill="currentColor">
                        <path d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                    </svg>
                    <input type="text" id="searchInput" oninput="searchChats()" placeholder="Pesquisar conversas" 
                        class="bg-transparent text-white text-sm ml-4 w-full focus:outline-none placeholder-[#8696a0]">
                </div>
            </div>

            <!-- Chats List -->
            <div id="chatsList" class="flex-1 overflow-y-auto scrollbar-thin"></div>
        </div>

        <!-- Right Panel - Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Empty State -->
            <div id="emptyState" class="flex-1 flex flex-col items-center justify-center bg-[#222e35]">
                <div class="text-center">
                    <div class="w-[250px] h-[250px] mx-auto mb-8 rounded-full bg-[#364147] flex items-center justify-center">
                        <svg class="w-32 h-32 text-[#8696a0]" viewBox="0 0 303 172" fill="currentColor">
                            <path d="M229.565 160.229c32.647-16.166 54.391-50.161 54.391-89.073 0-55.098-45.022-99.775-100.554-99.775-34.178 0-64.377 17.14-82.298 43.249-4.829-.632-9.754-.964-14.759-.964C38.63 13.666 0 52.056 0 99.573c0 21.026 7.567 40.283 20.133 55.264-.874 6.676-3.876 14.264-8.963 22.396l-.27.467c32.75-5.2 58.242-16.794 76.17-32.544 7.382 1.985 15.124 3.027 23.12 3.027 3.157 0 6.278-.146 9.357-.422 17.696 22.478 45.163 36.909 76.018 36.909 6.318 0 12.487-.616 18.464-1.79 13.233 12.326 31.933 22.233 56.536 26.9-5.09-8.132-8.092-15.72-8.966-22.391z"></path>
                        </svg>
                    </div>
                    <h2 class="text-[#e9edef] text-3xl font-light mb-4">WhatsApp Web</h2>
                    <p class="text-[#8696a0] max-w-md">Envie e receba mensagens em tempo real.<br>Clique em "Nova conversa" para comeÃ§ar!</p>
                </div>
            </div>

            <!-- Chat View (Hidden by default) -->
            <div id="chatView" class="hidden flex-1 flex flex-col">
                <!-- Chat Header -->
                <div class="h-14 bg-[#202c33] flex items-center justify-between px-4">
                    <div class="flex items-center gap-3 cursor-pointer">
                        <button class="md:hidden mr-2 text-[#aebac1]" onclick="closeChat()">
                            <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                                <path d="M12 4l1.4 1.4L7.8 11H20v2H7.8l5.6 5.6L12 20l-8-8 8-8z"></path>
                            </svg>
                        </button>
                        <div id="chatAvatar" class="w-10 h-10 rounded-full bg-[#6b7175] flex items-center justify-center text-white font-medium overflow-hidden">
                            <img id="chatAvatarImg" class="w-full h-full object-cover hidden" />
                            <span id="chatAvatarLetter"></span>
                        </div>
                        <div>
                            <h3 id="chatName" class="text-white font-medium"></h3>
                            <p id="chatStatus" class="text-[#8696a0] text-xs"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-5 text-[#aebac1]">
                        <span id="chatUserId" class="text-xs text-[#8696a0]"></span>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messagesArea" class="flex-1 overflow-y-auto chat-bg p-4 scrollbar-thin"></div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="hidden bg-[#202c33] px-4 py-2">
                    <span class="text-[#00a884] text-sm">digitando<span class="typing-indicator"><span>.</span><span>.</span><span>.</span></span></span>
                </div>

                <!-- Message Input -->
                <div class="bg-[#202c33] px-4 py-3 flex items-center gap-3 relative">
                    <!-- Emoji Picker -->
                    <div id="emojiPicker" class="hidden absolute bottom-16 left-4 bg-[#202c33] rounded-lg p-3 shadow-xl border border-[#374045] w-80 z-50">
                        <div class="emoji-grid scrollbar-thin" id="emojiGrid"></div>
                    </div>
                    
                    <button onclick="toggleEmojiPicker()" class="text-[#8696a0] hover:text-[#aebac1]">
                        <svg viewBox="0 0 24 24" class="w-7 h-7" fill="currentColor">
                            <path d="M9.153 11.603c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962zm-3.204 1.362c-.026-.307-.131 5.218 6.063 5.551 6.066-.25 6.066-5.551 6.066-5.551-6.078 1.416-12.129 0-12.129 0zm11.363 1.108s-.669 1.959-5.051 1.959c-3.505 0-5.388-1.164-5.607-1.959 0 0 5.912 1.055 10.658 0zM11.804 1.011C5.609 1.011.978 6.033.978 12.228s4.826 10.761 11.021 10.761S23.02 18.423 23.02 12.228c.001-6.195-5.021-11.217-11.216-11.217zM12 21.354c-5.273 0-9.381-3.886-9.381-9.159s3.942-9.548 9.215-9.548 9.548 4.275 9.548 9.548c-.001 5.272-4.109 9.159-9.382 9.159zm3.108-9.751c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962z"></path>
                        </svg>
                    </button>
                    <div class="flex-1">
                        <input type="text" id="messageInput" placeholder="Digite uma mensagem" 
                            onkeydown="handleKeyDown(event)" oninput="handleTyping()"
                            class="w-full px-4 py-2 bg-[#2a3942] text-white rounded-lg focus:outline-none placeholder-[#8696a0]">
                    </div>
                    <button onclick="sendMessage()" class="text-[#00a884] hover:text-[#02906f] transition-colors">
                        <svg viewBox="0 0 24 24" class="w-7 h-7" fill="currentColor">
                            <path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-[#202c33] rounded-lg w-96 max-h-[80vh] overflow-hidden">
            <div class="p-4 border-b border-[#374045]">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white text-lg">Nova conversa</h3>
                    <button onclick="hideNewChat()" class="text-[#aebac1] hover:text-white">
                        <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                            <path d="M19.1 17.2l-5.3-5.3 5.3-5.3-1.8-1.8-5.3 5.4-5.3-5.3-1.8 1.7 5.3 5.3-5.3 5.3L6.7 19l5.3-5.3 5.3 5.3 1.8-1.8z"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex items-center bg-[#2a3942] rounded-lg px-4 py-2">
                    <svg viewBox="0 0 24 24" class="w-5 h-5 text-[#8696a0]" fill="currentColor">
                        <path d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                    </svg>
                    <input type="text" id="searchUserInput" oninput="searchUsers()" placeholder="Buscar por nome ou ID" 
                        class="bg-transparent text-white text-sm ml-4 w-full focus:outline-none placeholder-[#8696a0]">
                </div>
            </div>
            <div id="usersList" class="overflow-y-auto max-h-80 scrollbar-thin"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-[#202c33] rounded-lg w-96 overflow-hidden">
            <div class="p-4 border-b border-[#374045]">
                <div class="flex items-center justify-between">
                    <h3 class="text-white text-lg">Meu Perfil</h3>
                    <button onclick="hideProfileModal()" class="text-[#aebac1] hover:text-white">
                        <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                            <path d="M19.1 17.2l-5.3-5.3 5.3-5.3-1.8-1.8-5.3 5.4-5.3-5.3-1.8 1.7 5.3 5.3-5.3 5.3L6.7 19l5.3-5.3 5.3 5.3 1.8-1.8z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <!-- Avatar Preview -->
                <div class="flex justify-center">
                    <div id="profileAvatarPreview" class="w-24 h-24 rounded-full bg-[#6b7175] flex items-center justify-center text-white text-3xl font-medium overflow-hidden">
                        <img id="profileAvatarImg" class="w-full h-full object-cover hidden" />
                        <span id="profileAvatarLetter"></span>
                    </div>
                </div>
                
                <!-- User ID -->
                <div class="bg-[#2a3942] rounded-lg p-3">
                    <p class="text-[#8696a0] text-xs mb-1">Seu ID (compartilhe para ser encontrado)</p>
                    <div class="flex items-center justify-between">
                        <span id="profileUserId" class="text-[#00a884] font-mono"></span>
                        <button onclick="copyUserId()" class="text-[#8696a0] hover:text-white">
                            <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Name -->
                <div>
                    <label class="text-[#8696a0] text-xs">Nome</label>
                    <input type="text" id="profileName" 
                        class="w-full mt-1 px-4 py-2 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884]">
                </div>

                <!-- Photo URL -->
                <div>
                    <label class="text-[#8696a0] text-xs">URL da Foto</label>
                    <input type="url" id="profilePhoto" placeholder="https://exemplo.com/foto.jpg"
                        class="w-full mt-1 px-4 py-2 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-500">
                </div>

                <!-- Bio -->
                <div>
                    <label class="text-[#8696a0] text-xs">Bio</label>
                    <textarea id="profileBio" rows="3" placeholder="Escreva algo sobre vocÃª..."
                        class="w-full mt-1 px-4 py-2 bg-[#2a3942] text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a884] placeholder-gray-500 resize-none"></textarea>
                </div>

                <button onclick="saveProfile()" 
                    class="w-full py-3 bg-[#00a884] text-white rounded-lg hover:bg-[#02906f] transition-colors font-medium">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0DhQ-EUs3Azqn7_tbB-W3S9ko0DaUWls",
            authDomain: "ghostchat-app-3a3f0.firebaseapp.com",
            projectId: "ghostchat-app-3a3f0",
            storageBucket: "ghostchat-app-3a3f0.firebasestorage.app",
            messagingSenderId: "781582052854",
            appId: "1:781582052854:web:7fba6eae2a372ce0e22bd7",
            databaseURL: "https://ghostchat-app-3a3f0-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Emojis
        const emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ‘»','ğŸ‘½','ğŸ¤–','ğŸƒ','ğŸ‘‹','ğŸ¤š','âœ‹','ğŸ–ï¸','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘Œ','ğŸ¤Œ','ğŸ¤','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ‘','âœï¸','ğŸ™Œ','ğŸ‘','ğŸ«¶','ğŸ™','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’¯','âœ”ï¸','âŒ','â—','â“','â•','â”','âš ï¸','ğŸš«','â›”','ğŸ”','â­','ğŸŒŸ','âœ¨','ğŸ’¥','ğŸ”¥','ğŸ‰','ğŸŠ','ğŸ˜‚','ğŸ¤£','ğŸ˜­','ğŸ’€','ğŸ˜','ğŸ—¿','ğŸ‘€','ğŸ’­','ğŸ¤¨','ğŸ˜³','ğŸ‘','ğŸ‘','â¤ï¸','ğŸ”¥','ğŸ™','ğŸ’¯','ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¦†','ğŸ¦…','ğŸ','ğŸ¢','ğŸŠ','ğŸ¦–','ğŸ¦•','ğŸŸ','ğŸ ','ğŸ³','ğŸ¬','ğŸ¦ˆ','ğŸ','ğŸŠ','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ«','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ','ğŸœ','ğŸ£','ğŸ¤','ğŸ—','ğŸ–','ğŸ°','ğŸ§','ğŸ©','ğŸª','ğŸ«','ğŸ¿','â˜•','ğŸº','ğŸ»','ğŸ¥¤','ğŸ§ƒ','ğŸ®','ğŸ•¹ï¸','ğŸ‘¾','ğŸ²','â™Ÿï¸','ğŸ’»','ğŸ–¥ï¸','âŒ¨ï¸','ğŸ–±ï¸','ğŸ“±','ğŸ“¡','ğŸŒ','âš™ï¸','ğŸ”§','ğŸ”¨','ğŸ’¾','ğŸ“‚','ğŸ“','ğŸ§ ','ğŸ¤–','ğŸš€','âœˆï¸','ğŸš—','ğŸï¸','ğŸš²','ğŸ ','ğŸ¢','ğŸ™ï¸','ğŸ“¦','ğŸ“Œ','ğŸ“','ğŸ”‘','ğŸ”’','ğŸ”“','ğŸ”Š','ğŸ”‡','ğŸ””','ğŸ§¨','ğŸ’£','ğŸŒ'];

        // App State
        let currentUser = null;
        let currentChat = null;
        let chats = {};
        let users = {};
        let typingTimeout = null;
        let currentChatUser = null;

        // Generate unique ID
        function generateUserId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadUserData(user.uid);
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function showError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        async function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!name || !email || !password) {
                showError('Preencha todos os campos');
                return;
            }

            if (password.length < 6) {
                showError('A senha deve ter no mÃ­nimo 6 caracteres');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uniqueId = generateUserId();
                
                const userData = {
                    id: userCredential.user.uid,
                    oderId: uniqueId,
                    oderId_lower: uniqueId.toLowerCase(),
                    name: name,
                    name_lower: name.toLowerCase(),
                    email: email,
                    photo: '',
                    bio: 'OlÃ¡! Estou usando WhatsApp.',
                    online: true,
                    lastSeen: Date.now()
                };

                await database.ref('users/' + userCredential.user.uid).set(userData);
                
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/email-already-in-use') {
                    showError('Este email jÃ¡ estÃ¡ em uso');
                } else if (error.code === 'auth/invalid-email') {
                    showError('Email invÃ¡lido');
                } else {
                    showError('Erro ao criar conta: ' + error.message);
                }
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Preencha todos os campos');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showError('Email ou senha incorretos');
                } else if (error.code === 'auth/invalid-email') {
                    showError('Email invÃ¡lido');
                } else {
                    showError('Erro ao entrar: ' + error.message);
                }
            }
        }

        async function logout() {
            if (currentUser) {
                await database.ref('users/' + currentUser.id).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
            auth.signOut();
        }

        async function loadUserData(uid) {
            const snapshot = await database.ref('users/' + uid).once('value');
            if (snapshot.exists()) {
                currentUser = snapshot.val();
                showMainApp();
            }
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('flex');

            updateMyAvatar();

            // Set user online
            database.ref('users/' + currentUser.id).update({ 
                online: true, 
                lastSeen: Date.now() 
            });

            // Handle disconnect
            database.ref('users/' + currentUser.id).onDisconnect().update({
                online: false,
                lastSeen: Date.now()
            });

            // Load data
            loadUsers();
            loadChats();
            initEmojiPicker();
        }

        function updateMyAvatar() {
            const imgEl = document.getElementById('myAvatarImg');
            const letterEl = document.getElementById('myAvatarLetter');
            
            if (currentUser.photo) {
                imgEl.src = currentUser.photo;
                imgEl.classList.remove('hidden');
                letterEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                letterEl.classList.remove('hidden');
                letterEl.textContent = currentUser.name.charAt(0).toUpperCase();
            }
        }

        function loadUsers() {
            database.ref('users').on('value', (snapshot) => {
                users = snapshot.val() || {};
                updateUsersList();
            });
        }

        function searchUsers() {
            const query = document.getElementById('searchUserInput').value.toLowerCase().trim();
            updateUsersList(query);
        }

        function updateUsersList(searchQuery = '') {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            const filteredUsers = Object.values(users).filter(user => {
                if (user.id === currentUser.id) return false;
                if (!searchQuery) return true;
                return user.name.toLowerCase().includes(searchQuery) || 
                       user.oderId.toLowerCase().includes(searchQuery);
            });

            if (filteredUsers.length === 0) {
                usersList.innerHTML = '<p class="text-[#8696a0] text-center p-4">Nenhum usuÃ¡rio encontrado</p>';
                return;
            }

            filteredUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center gap-3 p-3 hover:bg-[#2a3942] cursor-pointer transition-colors';
                userDiv.onclick = () => startChatWith(user);
                
                const avatarHtml = user.photo 
                    ? `<img src="${user.photo}" class="w-12 h-12 rounded-full object-cover" />`
                    : `<div class="w-12 h-12 rounded-full bg-[#6b7175] flex items-center justify-center text-white text-lg">${user.name.charAt(0).toUpperCase()}</div>`;
                
                userDiv.innerHTML = `
                    <div class="relative">
                        ${avatarHtml}
                        ${user.online ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-[#00a884] rounded-full border-2 border-[#202c33] online-dot"></div>' : ''}
                    </div>
                    <div class="flex-1">
                        <p class="text-white">${user.name}</p>
                        <p class="text-[#8696a0] text-sm">ID: ${user.oderId}</p>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }

        function loadChats() {
            database.ref('chats').orderByChild('participants/' + currentUser.id).equalTo(true).on('value', (snapshot) => {
                chats = snapshot.val() || {};
                renderChatsList();
            });
        }

        function renderChatsList() {
            const chatsList = document.getElementById('chatsList');
            chatsList.innerHTML = '';

            const chatArray = Object.entries(chats).map(([id, chat]) => ({
                id,
                ...chat,
                lastMessageTime: chat.lastMessage?.timestamp || 0
            })).sort((a, b) => b.lastMessageTime - a.lastMessageTime);

            if (chatArray.length === 0) {
                chatsList.innerHTML = '<p class="text-[#8696a0] text-center p-4">Nenhuma conversa ainda</p>';
                return;
            }

            chatArray.forEach(chat => {
                const otherUserId = Object.keys(chat.participants).find(id => id !== currentUser.id);
                const otherUser = users[otherUserId] || { name: 'UsuÃ¡rio', oderId: '?' };
                
                const chatDiv = document.createElement('div');
                chatDiv.className = `flex items-center gap-3 p-3 hover:bg-[#202c33] cursor-pointer transition-colors ${currentChat === chat.id ? 'bg-[#2a3942]' : ''}`;
                chatDiv.onclick = () => openChat(chat.id, otherUser);
                
                const lastMsg = chat.lastMessage || {};
                const time = lastMsg.timestamp ? formatTime(lastMsg.timestamp) : '';
                const unread = chat.unread?.[currentUser.id] || 0;
                
                const avatarHtml = otherUser.photo 
                    ? `<img src="${otherUser.photo}" class="w-12 h-12 rounded-full object-cover" />`
                    : `<div class="w-12 h-12 rounded-full bg-[#6b7175] flex items-center justify-center text-white text-lg">${otherUser.name?.charAt(0).toUpperCase() || '?'}</div>`;
                
                chatDiv.innerHTML = `
                    <div class="relative">
                        ${avatarHtml}
                        ${otherUser.online ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-[#00a884] rounded-full border-2 border-[#111b21] online-dot"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <span class="text-white font-medium truncate">${otherUser.name}</span>
                            <span class="text-[#8696a0] text-xs">${time}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-[#8696a0] text-sm truncate">${lastMsg.text || ''}</p>
                            ${unread > 0 ? `<span class="bg-[#00a884] text-white text-xs rounded-full px-2 py-0.5 ml-2">${unread}</span>` : ''}
                        </div>
                    </div>
                `;
                chatsList.appendChild(chatDiv);
            });
        }

        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        function startChatWith(user) {
            const chatId = getChatId(currentUser.id, user.id);
            
            database.ref(`chats/${chatId}`).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref(`chats/${chatId}`).set({
                        participants: {
                            [currentUser.id]: true,
                            [user.id]: true
                        },
                        createdAt: Date.now()
                    });
                }
                hideNewChat();
                openChat(chatId, user);
            });
        }

        function openChat(chatId, otherUser) {
            currentChat = chatId;
            currentChatUser = otherUser;
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('chatView').classList.add('flex');
            
            // Update avatar
            const avatarImg = document.getElementById('chatAvatarImg');
            const avatarLetter = document.getElementById('chatAvatarLetter');
            
            if (otherUser.photo) {
                avatarImg.src = otherUser.photo;
                avatarImg.classList.remove('hidden');
                avatarLetter.classList.add('hidden');
            } else {
                avatarImg.classList.add('hidden');
                avatarLetter.classList.remove('hidden');
                avatarLetter.textContent = otherUser.name?.charAt(0).toUpperCase() || '?';
            }
            
            document.getElementById('chatName').textContent = otherUser.name;
            document.getElementById('chatUserId').textContent = 'ID: ' + (otherUser.oderId || '');
            
            // Update status
            updateChatStatus(otherUser);
            
            // Mark as read
            database.ref(`chats/${chatId}/unread/${currentUser.id}`).set(0);
            
            // Load messages
            loadMessages(chatId);
            
            // Listen for typing
            listenForTyping(chatId, otherUser.id);
            
            // Listen for user updates
            database.ref('users/' + otherUser.id).on('value', (snapshot) => {
                if (snapshot.exists() && currentChat === chatId) {
                    const updatedUser = snapshot.val();
                    currentChatUser = updatedUser;
                    updateChatStatus(updatedUser);
                }
            });
            
            renderChatsList();
            
            // Focus input
            document.getElementById('messageInput').focus();
        }

        function updateChatStatus(otherUser) {
            const statusEl = document.getElementById('chatStatus');
            if (otherUser.online) {
                statusEl.textContent = 'online';
                statusEl.classList.add('text-[#00a884]');
            } else {
                statusEl.textContent = otherUser.lastSeen ? `visto por Ãºltimo ${formatLastSeen(otherUser.lastSeen)}` : '';
                statusEl.classList.remove('text-[#00a884]');
            }
        }

        function loadMessages(chatId) {
            const messagesArea = document.getElementById('messagesArea');
            
            database.ref(`messages/${chatId}`).orderByChild('timestamp').on('value', (snapshot) => {
                messagesArea.innerHTML = '';
                
                const messages = snapshot.val() || {};
                let lastDate = '';
                
                Object.values(messages).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
                    const msgDate = formatDate(msg.timestamp);
                    
                    if (msgDate !== lastDate) {
                        lastDate = msgDate;
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'flex justify-center my-4';
                        dateDiv.innerHTML = `<span class="bg-[#182229] text-[#8696a0] text-xs px-3 py-1 rounded-lg">${msgDate}</span>`;
                        messagesArea.appendChild(dateDiv);
                    }
                    
                    const isMe = msg.senderId === currentUser.id;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-1`;
                    msgDiv.innerHTML = `
                        <div class="relative max-w-[65%] px-3 py-2 rounded-lg ${isMe ? 'message-out' : 'message-in'} shadow">
                            <p class="text-[#111b21] text-sm pr-14 break-words">${escapeHtml(msg.text)}</p>
                            <div class="absolute bottom-1 right-2 flex items-center gap-1">
                                <span class="text-[#667781] text-[11px]">${formatTime(msg.timestamp)}</span>
                                ${isMe ? getCheckmarks(msg.status) : ''}
                            </div>
                        </div>
                    `;
                    messagesArea.appendChild(msgDiv);
                });
                
                messagesArea.scrollTop = messagesArea.scrollHeight;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCheckmarks(status) {
            if (status === 'read') {
                return '<svg viewBox="0 0 16 11" class="w-4 h-3 text-[#53bdeb]" fill="currentColor"><path d="M11.071.653a.457.457 0 0 0-.304-.102.493.493 0 0 0-.381.178l-6.19 7.636-2.405-2.272a.463.463 0 0 0-.336-.136.475.475 0 0 0-.347.147.473.473 0 0 0 .002.692l2.764 2.612a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l6.507-8.045a.464.464 0 0 0-.017-.657zm-5.107 7.636l-1.2-1.133a.463.463 0 0 0-.336-.136.475.475 0 0 0-.347.147.473.473 0 0 0 .002.692l1.559 1.472a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l.054-.066-.439-.923zm8.012-7.636a.457.457 0 0 0-.304-.102.493.493 0 0 0-.381.178l-6.19 7.636-1.028-.971-.439.923 1.103 1.041a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l6.549-8.097a.464.464 0 0 0-.017-.655z"></path></svg>';
            } else if (status === 'delivered') {
                return '<svg viewBox="0 0 16 11" class="w-4 h-3 text-[#667781]" fill="currentColor"><path d="M11.071.653a.457.457 0 0 0-.304-.102.493.493 0 0 0-.381.178l-6.19 7.636-2.405-2.272a.463.463 0 0 0-.336-.136.475.475 0 0 0-.347.147.473.473 0 0 0 .002.692l2.764 2.612a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l6.507-8.045a.464.464 0 0 0-.017-.657zm-5.107 7.636l-1.2-1.133a.463.463 0 0 0-.336-.136.475.475 0 0 0-.347.147.473.473 0 0 0 .002.692l1.559 1.472a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l.054-.066-.439-.923zm8.012-7.636a.457.457 0 0 0-.304-.102.493.493 0 0 0-.381.178l-6.19 7.636-1.028-.971-.439.923 1.103 1.041a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l6.549-8.097a.464.464 0 0 0-.017-.655z"></path></svg>';
            }
            return '<svg viewBox="0 0 12 11" class="w-3 h-3 text-[#667781]" fill="currentColor"><path d="M11.155.653a.457.457 0 0 0-.305-.102.493.493 0 0 0-.38.178L4.28 8.365 1.628 6.093a.463.463 0 0 0-.336-.136.475.475 0 0 0-.347.147.473.473 0 0 0 .002.692l2.764 2.612a.478.478 0 0 0 .322.123h.041a.482.482 0 0 0 .344-.176l6.507-8.045a.464.464 0 0 0-.017-.657z"></path></svg>';
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            const messageRef = database.ref(`messages/${currentChat}`).push();
            const message = {
                id: messageRef.key,
                text: text,
                senderId: currentUser.id,
                timestamp: Date.now(),
                status: 'sent'
            };
            
            messageRef.set(message);
            
            // Update chat
            const otherUserId = currentChat.split('_').find(id => id !== currentUser.id);
            database.ref(`chats/${currentChat}`).update({
                lastMessage: message,
                [`unread/${otherUserId}`]: firebase.database.ServerValue.increment(1)
            });
            
            // Clear typing
            database.ref(`typing/${currentChat}/${currentUser.id}`).remove();
            
            input.value = '';
            input.focus();
            
            // Close emoji picker
            document.getElementById('emojiPicker').classList.add('hidden');
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function handleTyping() {
            if (!currentChat) return;
            
            database.ref(`typing/${currentChat}/${currentUser.id}`).set(true);
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                database.ref(`typing/${currentChat}/${currentUser.id}`).remove();
            }, 2000);
        }

        function listenForTyping(chatId, otherUserId) {
            database.ref(`typing/${chatId}/${otherUserId}`).on('value', (snapshot) => {
                const indicator = document.getElementById('typingIndicator');
                if (snapshot.val()) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            });
        }

        // Emoji Picker
        function initEmojiPicker() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            
            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => insertEmoji(emoji);
                grid.appendChild(btn);
            });
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('hidden');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
            
            handleTyping();
        }

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('emojiPicker');
            const emojiBtn = e.target.closest('button');
            
            if (!picker.contains(e.target) && !emojiBtn?.querySelector('svg[viewBox="0 0 24 24"]')?.parentElement?.onclick?.toString().includes('toggleEmojiPicker')) {
                if (!e.target.closest('.emoji-btn') && !e.target.closest('button[onclick="toggleEmojiPicker()"]')) {
                    picker.classList.add('hidden');
                }
            }
        });

        function showNewChat() {
            document.getElementById('newChatModal').classList.remove('hidden');
            document.getElementById('searchUserInput').value = '';
            updateUsersList();
        }

        function hideNewChat() {
            document.getElementById('newChatModal').classList.add('hidden');
        }

        function closeChat() {
            currentChat = null;
            currentChatUser = null;
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('flex');
            document.getElementById('emptyState').classList.remove('hidden');
            renderChatsList();
        }

        function searchChats() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('#chatsList > div');
            
            items.forEach(item => {
                const name = item.querySelector('.text-white')?.textContent.toLowerCase() || '';
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        // Profile Modal
        function showProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profilePhoto').value = currentUser.photo || '';
            document.getElementById('profileBio').value = currentUser.bio || '';
            document.getElementById('profileUserId').textContent = currentUser.oderId;
            
            // Update preview
            const imgEl = document.getElementById('profileAvatarImg');
            const letterEl = document.getElementById('profileAvatarLetter');
            
            if (currentUser.photo) {
                imgEl.src = currentUser.photo;
                imgEl.classList.remove('hidden');
                letterEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                letterEl.classList.remove('hidden');
                letterEl.textContent = currentUser.name.charAt(0).toUpperCase();
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const photo = document.getElementById('profilePhoto').value.trim();
            const bio = document.getElementById('profileBio').value.trim();

            if (!name) {
                alert('O nome nÃ£o pode estar vazio');
                return;
            }

            const updates = {
                name: name,
                name_lower: name.toLowerCase(),
                photo: photo,
                bio: bio
            };

            await database.ref('users/' + currentUser.id).update(updates);
            
            currentUser = { ...currentUser, ...updates };
            updateMyAvatar();
            hideProfileModal();
        }

        function copyUserId() {
            navigator.clipboard.writeText(currentUser.oderId);
            alert('ID copiado: ' + currentUser.oderId);
        }

        // Utility functions
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Hoje';
            if (date.toDateString() === yesterday.toDateString()) return 'Ontem';
            return date.toLocaleDateString('pt-BR');
        }

        function formatLastSeen(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'agora';
            if (diff < 3600000) return `hÃ¡ ${Math.floor(diff / 60000)} min`;
            if (date.toDateString() === now.toDateString()) return `hoje Ã s ${formatTime(timestamp)}`;
            return `${formatDate(timestamp)} Ã s ${formatTime(timestamp)}`;
        }
    </script>
</body>
</html>
