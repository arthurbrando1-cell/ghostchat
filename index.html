<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostChat Pro - Delete Msg</title>
    <style>
        :root {
            --bg-main: #111b21; --bg-sidebar: #111b21; --bg-panel: #202c33;
            --bg-chat: #0b141a; --accent: #00a884; --text-main: #e9edef;
            --text-dim: #8696a0; --msg-own: #005c4b; --msg-other: #202c33;
            --danger: #ea0038;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-main); color: var(--text-main); height: 100vh; overflow: hidden; }
        #app { display: flex; width: 100vw; height: 100vh; }

        /* Sidebar */
        .sidebar { width: 30%; min-width: 320px; background: var(--bg-sidebar); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .sidebar-header { background: var(--bg-panel); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
        .chat-item:hover { background: #2a3942; }
        .chat-item img { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; }

        /* Chat */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: var(--bg-chat); background-blend-mode: overlay; }
        .chat-header { background: var(--bg-panel); padding: 10px 16px; display: flex; align-items: center; height: 60px; }
        
        #messages-container { flex: 1; overflow-y: auto; padding: 20px 5%; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-wrapper { display: flex; align-items: flex-end; gap: 8px; max-width: 75%; position: relative; }
        .msg-wrapper.own { align-self: flex-end; flex-direction: row-reverse; }
        .msg-bubble { padding: 8px 12px; border-radius: 10px; font-size: 15px; cursor: pointer; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .own .msg-bubble { background: var(--msg-own); border-bottom-right-radius: 2px; }
        .other .msg-bubble { background: var(--msg-other); border-bottom-left-radius: 2px; }
        .deleted-text { font-style: italic; color: var(--text-dim); font-size: 13px; }

        /* Input */
        .input-bar { background: var(--bg-panel); padding: 10px 16px; display: flex; align-items: center; gap: 12px; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 12px 18px; border-radius: 25px; color: white; outline: none; }

        /* Modais */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--bg-panel); padding: 25px; border-radius: 20px; width: 350px; text-align: center; }
        .profile-id-tag { background: #111b21; padding: 10px; border-radius: 10px; border: 1px dashed var(--accent); color: var(--accent); font-weight: bold; margin: 15px 0; font-size: 20px; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; background: #111b21; border: 1px solid #3b4a54; color: white; border-radius: 8px; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #emoji-picker { position: absolute; bottom: 70px; left: 20px; background: var(--bg-panel); width: 300px; max-height: 200px; overflow-y: auto; display: none; grid-template-columns: repeat(7, 1fr); padding: 10px; border-radius: 10px; z-index: 100; }
        .emoji-item { font-size: 22px; padding: 5px; cursor: pointer; text-align: center; }

        .active { display: flex !important; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background:var(--bg-main); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="margin-bottom: 20px;">ðŸ‘» GhostChat</h1>
        <button onclick="handleLogin()" class="btn-save" style="width:200px">ENTRAR</button>
    </div>

    <div id="app" class="hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="" id="my-pfp" class="avatar" onclick="openModal('modal-profile')">
                <span onclick="openModal('modal-add')" style="cursor:pointer; font-size:24px">ï¼‹</span>
            </div>
            <div class="chat-list" id="chat-list-ui"></div>
        </div>
        <div class="main-chat">
            <div class="chat-header" id="header-ui" style="visibility:hidden">
                <img src="" id="target-pfp" class="avatar" style="margin-right:15px">
                <h4 id="target-name">Nome</h4>
            </div>
            <div id="messages-container"></div>
            <div id="emoji-picker"></div>
            <form class="input-bar" id="chat-form">
                <span onclick="toggleEmojis()" style="cursor:pointer; font-size:24px">ðŸ˜Š</span>
                <input type="text" id="msg-input" placeholder="Mensagem" autocomplete="off">
                <button type="submit" style="background:none; border:none; color:var(--accent); font-size:24px; cursor:pointer">âž¤</button>
            </form>
        </div>
    </div>

    <div id="modal-profile" class="modal">
        <div class="modal-content">
            <h3>Meu Perfil</h3>
            <div class="profile-id-tag" id="display-id">----</div>
            <input type="text" id="in-name" placeholder="Nome">
            <input type="text" id="in-pic" placeholder="URL da Foto">
            <button class="btn-save" onclick="saveProfile()">SALVAR</button>
            <button onclick="closeModals()" style="background:none; border:none; color:white; margin-top:10px; cursor:pointer">Voltar</button>
        </div>
    </div>

    <div id="modal-add" class="modal">
        <div class="modal-content">
            <h3>Novo Chat</h3>
            <input type="text" id="search-id" placeholder="Digite o ID">
            <button class="btn-save" onclick="findGhost()">BUSCAR</button>
        </div>
    </div>

    <div id="modal-delete" class="modal">
        <div class="modal-content">
            <h3>Apagar Mensagem?</h3>
            <button class="btn-save" onclick="deleteForMe()">Apagar para mim</button>
            <button class="btn-danger" id="btn-delete-all" onclick="deleteForEveryone()">Apagar para todos</button>
            <button onclick="closeModals()" style="background:none; border:none; color:white; margin-top:15px; cursor:pointer">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDocs, where, limit, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0DhQ-EUs3Azqn7_tbB-W3S9ko0DaUWls",
            authDomain: "ghostchat-app-3a3f0.firebaseapp.com",
            projectId: "ghostchat-app-3a3f0",
            storageBucket: "ghostchat-app-3a3f0.firebasestorage.app",
            messagingSenderId: "781582052854",
            appId: "1:781582052854:web:7fba6eae2a372ce0e22bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myData = {}, activeChatId = null, activeTarget = null, unsub = null, selectedMsgId = null;
        const ping = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        window.handleLogin = () => signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const gid = localStorage.getItem('ghost_id') || Math.floor(1000 + Math.random() * 9000).toString();
                localStorage.setItem('ghost_id', gid);
                myData = { uid: user.uid, ghostId: gid, name: localStorage.getItem('ghost_name') || `Ghost#${gid}`, pic: localStorage.getItem('ghost_pic') || `https://api.dicebear.com/7.x/bottts/svg?seed=${gid}` };
                await setDoc(doc(db, "users", user.uid), myData, { merge: true });
                document.getElementById('my-pfp').src = myData.pic;
                document.getElementById('display-id').innerText = myData.ghostId;
                document.getElementById('in-name').value = myData.name;
                document.getElementById('in-pic').value = myData.pic;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadSidebar();
            }
        });

        window.saveProfile = async () => {
            myData.name = document.getElementById('in-name').value;
            myData.pic = document.getElementById('in-pic').value;
            localStorage.setItem('ghost_name', myData.name);
            localStorage.setItem('ghost_pic', myData.pic);
            await setDoc(doc(db, "users", auth.currentUser.uid), myData, { merge: true });
            location.reload();
        };

        function startChat(target) {
            activeTarget = target;
            activeChatId = [myData.uid, target.uid].sort().join('_');
            document.getElementById('header-ui').style.visibility = 'visible';
            document.getElementById('target-name').innerText = target.name;
            document.getElementById('target-pfp').src = target.pic;
            if(unsub) unsub();
            const q = query(collection(db, "messages"), where("chatId", "==", activeChatId), orderBy("timestamp", "asc"));
            let isFirst = true;
            unsub = onSnapshot(q, (snap) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const hiddenFor = m.hiddenFor || [];
                    if(hiddenFor.includes(myData.uid)) return; // NÃ£o mostra se apaguei "para mim"

                    const isOwn = m.senderId === myData.uid;
                    const wrap = document.createElement('div');
                    wrap.className = `msg-wrapper ${isOwn ? 'own' : 'other'}`;
                    
                    let content = m.isDeleted ? '<span class="deleted-text">ðŸš« Esta mensagem foi apagada</span>' : m.text;
                    
                    wrap.innerHTML = `<div class="msg-bubble" onclick="handleMsgClick('${d.id}', ${isOwn}, ${m.isDeleted})">${content}</div>`;
                    container.appendChild(wrap);
                });
                container.scrollTop = container.scrollHeight;
                if(!isFirst && snap.docChanges().some(c => c.type === 'added' && c.doc.data().senderId !== myData.uid)) ping.play();
                isFirst = false;
            });
        }

        window.handleMsgClick = (id, isOwn, isDeleted) => {
            if(isDeleted) return;
            selectedMsgId = id;
            document.getElementById('btn-delete-all').style.display = isOwn ? 'block' : 'none';
            openModal('modal-delete');
        };

        window.deleteForMe = async () => {
            const ref = doc(db, "messages", selectedMsgId);
            const snap = await getDocs(query(collection(db, "messages"), where("__name__", "==", selectedMsgId)));
            const hiddenFor = snap.docs[0].data().hiddenFor || [];
            hiddenFor.push(myData.uid);
            await updateDoc(ref, { hiddenFor });
            closeModals();
        };

        window.deleteForEveryone = async () => {
            await updateDoc(doc(db, "messages", selectedMsgId), { text: "", isDeleted: true });
            closeModals();
        };

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            if(input.value.trim() && activeChatId) {
                const text = input.value; input.value = '';
                await addDoc(collection(db, "messages"), { chatId: activeChatId, participants: [myData.uid, activeTarget.uid], senderId: myData.uid, text: text, timestamp: serverTimestamp(), isDeleted: false, hiddenFor: [] });
            }
        };

        function loadSidebar() {
            const q = query(collection(db, "messages"), where("participants", "array-contains", myData.uid));
            onSnapshot(q, async (snap) => {
                const list = document.getElementById('chat-list-ui');
                const uids = new Set();
                snap.forEach(d => d.data().participants.forEach(p => { if(p !== myData.uid) uids.add(p); }));
                list.innerHTML = '';
                for(let uid of uids) {
                    const uSnap = await getDocs(query(collection(db, "users"), where("uid", "==", uid)));
                    if(!uSnap.empty) {
                        const u = uSnap.docs[0].data();
                        const item = document.createElement('div');
                        item.className = 'chat-item';
                        item.innerHTML = `<img src="${u.pic}"> <div><b>${u.name}</b><br><small>ID: ${u.ghostId}</small></div>`;
                        item.onclick = () => startChat(u);
                        list.appendChild(item);
                    }
                }
            });
        }

        const emojis = "ðŸ˜€ðŸ˜ƒðŸ˜„ðŸ˜ðŸ˜†ðŸ˜…ðŸ˜‚ðŸ¤£ðŸ˜ŠðŸ˜‡ðŸ™‚ðŸ™ƒðŸ˜‰ðŸ˜ŒðŸ˜ðŸ¥°ðŸ˜˜ðŸ˜—ðŸ˜™ðŸ˜šðŸ˜‹ðŸ˜›ðŸ˜œðŸ¤ªðŸ˜ðŸ¤‘ðŸ¤—ðŸ¤­ðŸ¤«ðŸ¤”ðŸ˜ðŸ˜‘ðŸ˜¶ðŸ˜ðŸ˜’ðŸ™„ðŸ˜¬ðŸ¤¥ðŸ˜ŒðŸ˜”ðŸ˜ªðŸ¤¤ðŸ˜´";
        const picker = document.getElementById('emoji-picker');
        emojis.match(/./gu).forEach(e => {
            const s = document.createElement('span'); s.className = 'emoji-item'; s.innerText = e;
            s.onclick = () => { document.getElementById('msg-input').value += e; };
            picker.appendChild(s);
        });
        window.toggleEmojis = () => picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid';
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        window.findGhost = async () => {
            const id = document.getElementById('search-id').value;
            const s = await getDocs(query(collection(db, "users"), where("ghostId", "==", id), limit(1)));
            if(!s.empty) { startChat(s.docs[0].data()); closeModals(); } else alert("ID nÃ£o encontrado!");
        };
    </script>
</body>
</html>
