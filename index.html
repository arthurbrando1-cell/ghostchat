<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostChat Ultra Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #111b21; --bg-sidebar: #111b21; --bg-panel: #202c33;
            --bg-chat: #0b141a; --accent: #00a884; --text-main: #e9edef;
            --text-dim: #8696a0; --msg-own: #005c4b; --msg-other: #202c33; --danger: #ea0038;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-main); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        #app { display: flex; width: 100vw; height: 100vh; }
        .sidebar { width: 30%; min-width: 320px; background: var(--bg-sidebar); border-right: 1px solid #313d45; display: flex; flex-direction: column; }
        
        /* STATUS BAR */
        .status-bar { display: flex; gap: 12px; padding: 12px; overflow-x: auto; background: var(--bg-sidebar); border-bottom: 1px solid #222e35; scrollbar-width: none; }
        .status-dot { min-width: 60px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .status-circle { width: 54px; height: 54px; border-radius: 50%; border: 3px solid var(--accent); padding: 2px; object-fit: cover; }
        .status-name { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

        .sidebar-header { background: var(--bg-panel); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #222e35; gap: 12px; }

        /* CHAT AREA */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; background-size: cover; background-position: center; }
        .chat-header { background: var(--bg-panel); padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #333; z-index: 10; }
        
        /* ADMIN PANEL */
        #group-admin-panel { background: var(--bg-panel); padding: 15px; display: none; max-height: 300px; overflow-y: auto; border-bottom: 2px solid var(--accent); position: relative; z-index: 5; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111b21; margin-bottom: 5px; border-radius: 8px; }

        #messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
        .msg { padding: 10px; border-radius: 10px; color: white; max-width: 65%; position: relative; }
        .msg-me { align-self: flex-end; background: var(--msg-own); }
        .msg-other { align-self: flex-start; background: var(--msg-other); }
        .v-check { font-size: 10px; margin-left: 5px; color: #4fc3f7; float: right; margin-top: 5px; }

        .input-bar { background: var(--bg-panel); padding: 12px; display: flex; align-items: center; gap: 12px; position: absolute; bottom: 0; width: 100%; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 20px; color: white; outline: none; }
        
        .emoji-picker { position: absolute; bottom: 70px; left: 15px; background: var(--bg-panel); width: 320px; height: 250px; overflow-y: auto; display: none; grid-template-columns: repeat(7, 1fr); padding: 10px; border-radius: 10px; border: 1px solid #444; z-index: 5000; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: var(--bg-panel); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; }
        .btn-action { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        
        .p-banner { height: 100px; background: var(--accent); background-size: cover; }
        .p-avatar-big { width: 80px; height: 80px; border: 4px solid var(--bg-panel); border-radius: 50%; margin-top: -40px; margin-left: 15px; object-fit: cover; }
        .hidden { display: none !important; }
        .icon-btn { background: none; border: none; color: var(--text-dim); font-size: 22px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background:white; z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h2 style="color:#111">GHOST CHAT</h2>
        <button id="login-btn" class="btn-action" style="background:#111; width:220px">ENTRAR</button>
    </div>

    <div id="app" class="hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="" id="my-pfp" class="avatar" onclick="openProfile(true)">
                <div style="display:flex; gap:15px">
                    <button class="icon-btn" onclick="openModal('modal-post-status')"><i class="fa-solid fa-plus-circle"></i></button>
                    <button class="icon-btn" onclick="openModal('modal-group')"><i class="fa-solid fa-users"></i></button>
                    <button class="icon-btn" onclick="openModal('modal-add')"><i class="fa-solid fa-user-plus"></i></button>
                </div>
            </div>
            <div class="status-bar" id="status-circles"></div>
            <div class="chat-list" id="chat-list-ui"></div>
        </div>

        <div class="main-chat" id="chat-bg">
            <div id="chat-header-ui" class="chat-header" style="display:none">
                <img src="" id="target-pic" class="avatar" onclick="handleHeaderClick()">
                <div style="flex:1" onclick="handleHeaderClick()">
                    <h4 id="target-name">Nome</h4>
                </div>
                <button class="icon-btn" onclick="openModal('modal-wallpaper')"><i class="fa-solid fa-image"></i></button>
                <button id="delete-chat-btn" class="icon-btn hidden" onclick="deleteGroup()" style="color:var(--danger)"><i class="fa-solid fa-trash"></i></button>
                <button class="icon-btn" onclick="closeChat()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="group-admin-panel">
                <h4>Admin do Grupo</h4>
                <div style="margin: 10px 0; display:flex; flex-direction:column; gap:8px">
                    <input type="text" id="edit-g-name" placeholder="Mudar Nome" style="padding:8px; background:#111; color:white; border:none">
                    <label style="font-size:12px">Mudar Foto:</label>
                    <input type="file" onchange="updateGroupPic(this)" style="font-size:12px">
                    <button onclick="saveGroupName()" class="btn-action" style="margin:0">Salvar Altera√ß√µes</button>
                </div>
                <hr style="opacity:0.1; margin:10px 0">
                <h5>Membros:</h5>
                <div id="members-list-scroll"></div>
            </div>

            <div id="messages-container"></div>
            <div class="emoji-picker" id="emoji-picker"></div>

            <div class="input-bar">
                <button class="icon-btn" onclick="toggleEmoji()"><i class="fa-regular fa-face-smile"></i></button>
                <label for="chat-file" class="icon-btn"><i class="fa-solid fa-paperclip"></i></label>
                <input type="file" id="chat-file" hidden onchange="uploadToChat(this)">
                <input type="text" id="msg-input" placeholder="Mensagem..." onkeypress="if(event.key==='Enter')sendText()">
                <button onclick="sendText()" class="icon-btn" style="color:var(--accent)"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-wallpaper" class="modal"><div class="modal-content">
        <h3>Fundo da Conversa</h3>
        <input type="text" id="wall-url" placeholder="URL da Imagem" style="width:100%; padding:10px; margin:10px 0; background:#111; color:white; border:none">
        <p style="text-align:center">OU</p>
        <input type="file" onchange="uploadWallpaper(this)" style="margin:10px 0">
        <button class="btn-action" onclick="applyWallUrl()">Aplicar URL</button>
        <button class="btn-action" style="background:#444" onclick="closeModals()">Fechar</button>
    </div></div>

    <div id="modal-profile" class="modal"><div class="modal-content" style="padding:0; overflow:hidden">
        <div id="p-banner" class="p-banner"></div>
        <img src="" id="p-avatar" class="p-avatar-big">
        <div style="padding:20px">
            <h2 id="p-name">Nome</h2>
            <p id="p-bio" style="color:var(--text-dim); margin:10px 0"></p>
            <div id="edit-profile-fields" class="hidden">
                <input type="text" id="edit-name" placeholder="Nome" style="width:100%; padding:8px; margin-bottom:10px">
                <input type="text" id="edit-bio" placeholder="Bio" style="width:100%; padding:8px; margin-bottom:10px">
                <button class="btn-action" onclick="saveProfile()">Salvar</button>
            </div>
            <button id="block-btn" class="btn-action" style="background:var(--danger)" onclick="blockCurrentUser()">Bloquear Usu√°rio</button>
            <button class="btn-action" style="background:#444" onclick="closeModals()">Fechar</button>
        </div>
    </div></div>

    <div id="modal-post-status" class="modal"><div class="modal-content">
        <h3>Novo Status</h3>
        <input type="text" id="status-title" placeholder="Legenda..." style="width:100%; padding:10px; margin:10px 0; background:#111; color:white; border:none">
        <input type="file" id="status-file-input">
        <button class="btn-action" onclick="postStatus()">Publicar</button>
    </div></div>

    <div id="modal-view-status" class="modal" onclick="closeModals()"><div class="modal-content" style="background:transparent; text-align:center">
        <h3 id="view-status-name"></h3>
        <img src="" id="view-status-img" style="max-width:100%; max-height:70vh; border-radius:10px">
        <p id="view-status-title" style="color:white; font-size:18px; margin-top:10px"></p>
    </div></div>

    <div id="modal-group" class="modal"><div class="modal-content">
        <h3>Novo Grupo</h3>
        <input type="text" id="g-name" placeholder="Nome do Grupo" style="width:100%; padding:10px; margin:10px 0">
        <button class="btn-action" onclick="createGroup()">Criar</button>
    </div></div>

    <div id="modal-add" class="modal"><div class="modal-content">
        <h3>Adicionar ID</h3>
        <input type="text" id="search-id" style="width:100%; padding:10px; margin:10px 0">
        <div id="search-res"></div>
    </div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0DhQ-EUs3Azqn7_tbB-W3S9ko0DaUWls",
            authDomain: "ghostchat-app-3a3f0.firebaseapp.com",
            projectId: "ghostchat-app-3a3f0",
            storageBucket: "ghostchat-app-3a3f0.firebasestorage.app",
            messagingSenderId: "781582052854",
            appId: "1:781582052854:web:7fba6eae2a372ce0e22bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myData = {}, activeChatId = null, currentTarget = null;

        document.getElementById('login-btn').onclick = () => signInAnonymously(auth);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) myData = snap.data();
                else {
                    const gid = Math.floor(1000+Math.random()*9000).toString();
                    myData = { uid: user.uid, ghostId: gid, name: `Ghost#${gid}`, pic: `https://api.dicebear.com/7.x/bottts/svg?seed=${gid}`, bio: "Ghosting...", banner: "" };
                    await setDoc(doc(db, "users", user.uid), myData);
                }
                document.getElementById('my-pfp').src = myData.pic;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadContacts();
                loadStatusCircles();
            }
        });

        // WALLPAPER
        window.applyWallUrl = () => {
            const url = document.getElementById('wall-url').value;
            document.getElementById('chat-bg').style.backgroundImage = `url(${url})`;
            closeModals();
        };
        window.uploadWallpaper = (el) => {
            const r = new FileReader(); r.readAsDataURL(el.files[0]);
            r.onload = () => { document.getElementById('chat-bg').style.backgroundImage = `url(${r.result})`; closeModals(); };
        };

        // GEST√ÉO GRUPO
        window.updateGroupPic = (el) => {
            const r = new FileReader(); r.readAsDataURL(el.files[0]);
            r.onload = async () => {
                await updateDoc(doc(db, "users", myData.uid, "contacts", currentTarget.uid), { pic: r.result });
                document.getElementById('target-pic').src = r.result;
            };
        };
        window.removeMember = async (id) => {
            if(confirm("Remover este contato?")) {
                await deleteDoc(doc(db, "users", myData.uid, "contacts", id));
                document.getElementById('group-admin-panel').style.display = 'none';
            }
        };

        // BLOQUEIO
        window.blockCurrentUser = async () => {
            if(confirm("Bloquear este usu√°rio?")) {
                await deleteDoc(doc(db, "users", myData.uid, "contacts", currentTarget.uid));
                location.reload();
            }
        };

        // STATUS E CHAT (Igual ao anterior, mas com o √≠cone de check)
        window.postStatus = () => {
            const file = document.getElementById('status-file-input').files[0];
            const title = document.getElementById('status-title').value;
            if(!file) return;
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = async () => {
                await setDoc(doc(db, "status", myData.uid), { url: r.result, title, name: myData.name, pic: myData.pic });
                closeModals();
            };
        };

        function loadStatusCircles() {
            onSnapshot(collection(db, "status"), (snap) => {
                const bar = document.getElementById('status-circles'); bar.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    const dot = document.createElement('div');
                    dot.className = 'status-dot';
                    dot.innerHTML = `<img src="${s.pic}" class="status-circle"><span class="status-name">${s.name}</span>`;
                    dot.onclick = () => {
                        document.getElementById('view-status-img').src = s.url;
                        document.getElementById('view-status-name').innerText = s.name;
                        document.getElementById('view-status-title').innerText = s.title;
                        openModal('modal-view-status');
                    };
                    bar.appendChild(dot);
                });
            });
        }

        window.sendText = () => {
            const v = document.getElementById('msg-input').value;
            if(!v.trim()) return;
            sendMsg(v, 'text');
            document.getElementById('msg-input').value = "";
        };

        async function sendMsg(content, type) {
            if(!activeChatId) return;
            await addDoc(collection(db, "messages"), { chatId: activeChatId, senderId: myData.uid, content, type, timestamp: serverTimestamp() });
        }

        function loadMessages() {
            const q = query(collection(db, "messages"), where("chatId", "==", activeChatId), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const cont = document.getElementById('messages-container'); cont.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data(); const isMe = m.senderId === myData.uid;
                    const div = document.createElement('div'); div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
                    div.innerHTML = m.content + (isMe ? '<span class="v-check"><i class="fa-solid fa-check-double"></i></span>' : '');
                    cont.appendChild(div);
                });
                cont.scrollTop = cont.scrollHeight;
            });
        }

        window.handleHeaderClick = () => {
            if(currentTarget.isGroup) {
                const p = document.getElementById('group-admin-panel');
                p.style.display = p.style.display === 'block' ? 'none' : 'block';
                loadGroupMembers();
            } else {
                document.getElementById('block-btn').classList.remove('hidden');
                openProfile(false);
            }
        };

        async function loadGroupMembers() {
            const list = document.getElementById('members-list-scroll');
            const snap = await getDocs(collection(db, "users", myData.uid, "contacts"));
            list.innerHTML = "";
            snap.forEach(uDoc => {
                const u = uDoc.data();
                if(!u.isGroup) {
                    list.innerHTML += `<div class="member-item"><span>${u.name}</span> <button class="icon-btn" style="color:red" onclick="removeMember('${u.uid}')"><i class="fa-solid fa-xmark"></i></button></div>`;
                }
            });
        }

        window.openProfile = async (isMe) => {
            const u = isMe ? myData : (await getDoc(doc(db, "users", currentTarget.uid))).data();
            document.getElementById('p-name').innerText = u.name;
            document.getElementById('p-bio').innerText = u.bio;
            document.getElementById('p-avatar').src = u.pic;
            document.getElementById('p-banner').style.backgroundImage = `url(${u.banner})`;
            document.getElementById('edit-profile-fields').classList.toggle('hidden', !isMe);
            document.getElementById('block-btn').classList.toggle('hidden', isMe);
            openModal('modal-profile');
        };

        function loadContacts() {
            onSnapshot(collection(db, "users", myData.uid, "contacts"), (snap) => {
                const ui = document.getElementById('chat-list-ui'); ui.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div'); div.className = 'chat-item';
                    div.innerHTML = `<img src="${c.pic}" class="avatar"> <b>${c.name}</b>`;
                    div.onclick = () => {
                        activeChatId = c.isGroup ? c.uid : [myData.uid, c.uid].sort().join('_');
                        currentTarget = c;
                        document.getElementById('chat-header-ui').style.display = 'flex';
                        document.getElementById('target-name').innerText = c.name;
                        document.getElementById('target-pic').src = c.pic;
                        document.getElementById('delete-chat-btn').classList.toggle('hidden', !c.isGroup);
                        loadMessages();
                    };
                    ui.appendChild(div);
                });
            });
        }

        window.openModal = id => document.getElementById(id).style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        window.toggleEmoji = () => { const p = document.getElementById('emoji-picker'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; };
        const emojis = "üòÄüòÉüòÑüòÅüòÜüòÖüòÇü§£üòäüòáüôÇüôÉüòâüòåüòçü•∞üòòüòóüòôüòöüòãüòõüòúü§™üòùü§ëü§óü§≠ü§´ü§îüòêüòëüò∂üòèüòíüôÑüò¨ü§•üòåüòîüò™ü§§üò¥üò∑ü§íü§ïü§¢ü§Æü§ßüòµü§Øü§†ü•≥üòéü§ìüßêüòïüòüüôÅ‚òπÔ∏èüòÆüòØüò≤üò≥ü•∫üò¶üòßüò®üò∞üò•üò¢üò≠üò§üò†üò°ü§¨üòàüëøüíÄ‚ò†Ô∏èüëªüëΩü§ñ";
        [...emojis].forEach(e => { const s = document.createElement('span'); s.innerText = e; s.onclick = () => document.getElementById('msg-input').value += e; document.getElementById('emoji-picker').appendChild(s); });
    </script>
</body>
</html>
