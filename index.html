<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostChat Final Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #111b21; --bg-sidebar: #111b21; --bg-panel: #202c33;
            --bg-chat: #0b141a; --accent: #00a884; --text-main: #e9edef;
            --text-dim: #8696a0; --msg-own: #005c4b; --msg-other: #202c33; --danger: #ea0038;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-main); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        #app { display: flex; width: 100vw; height: 100vh; }
        .sidebar { width: 30%; min-width: 320px; background: var(--bg-sidebar); border-right: 1px solid #313d45; display: flex; flex-direction: column; }
        
        /* STATUS BAR */
        .status-bar { display: flex; gap: 12px; padding: 12px; overflow-x: auto; background: var(--bg-sidebar); border-bottom: 1px solid #222e35; scrollbar-width: none; }
        .status-dot { min-width: 60px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .status-circle { width: 54px; height: 54px; border-radius: 50%; border: 3px solid var(--accent); padding: 2px; object-fit: cover; }
        .status-name { font-size: 11px; color: var(--text-dim); margin-top: 4px; text-align: center; }

        .sidebar-header { background: var(--bg-panel); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #222e35; gap: 12px; }

        /* CHAT AREA */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        .chat-header { background: var(--bg-panel); padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #333; }
        
        /* ADMIN PANEL */
        #group-admin-panel { background: var(--bg-panel); padding: 15px; display: none; max-height: 250px; overflow-y: auto; border-bottom: 2px solid var(--accent); }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #111b21; margin-bottom: 5px; border-radius: 5px; }

        #messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
        .msg { padding: 10px; border-radius: 10px; color: white; max-width: 65%; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: var(--msg-own); }
        .msg-other { align-self: flex-start; background: var(--msg-other); }

        /* INPUT */
        .input-bar { background: var(--bg-panel); padding: 12px; display: flex; align-items: center; gap: 12px; position: absolute; bottom: 0; width: 100%; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 20px; color: white; outline: none; }
        
        .emoji-picker { position: absolute; bottom: 70px; left: 15px; background: var(--bg-panel); width: 320px; height: 250px; overflow-y: auto; display: none; grid-template-columns: repeat(7, 1fr); padding: 10px; border-radius: 10px; border: 1px solid #444; z-index: 5000; }
        .emoji-picker span { cursor: pointer; font-size: 24px; text-align: center; padding: 5px; }

        /* MODAIS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: var(--bg-panel); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; }
        .btn-action { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        
        /* DISCORD PROFILE */
        .p-banner { height: 100px; background: var(--accent); background-size: cover; border-radius: 10px 10px 0 0; }
        .p-avatar-big { width: 80px; height: 80px; border: 4px solid var(--bg-panel); border-radius: 50%; margin-top: -40px; margin-left: 15px; object-fit: cover; background: #333; }

        .hidden { display: none !important; }
        .icon-btn { background: none; border: none; color: var(--text-dim); font-size: 22px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background:white; z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <img src="https://raw.githubusercontent.com/VInivv/ghostchat/main/Ghost.png" width="100">
        <h2 style="color:#111; margin: 20px 0;">GHOST CHAT</h2>
        <button id="login-btn" class="btn-action" style="background:#111; width:220px">ENTRAR NO SISTEMA</button>
    </div>

    <div id="app" class="hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="" id="my-pfp" class="avatar" onclick="openProfile(true)">
                <div style="display:flex; gap:15px">
                    <button class="icon-btn" onclick="openModal('modal-post-status')"><i class="fa-solid fa-plus-circle"></i></button>
                    <button class="icon-btn" onclick="openModal('modal-group')"><i class="fa-solid fa-users"></i></button>
                    <button class="icon-btn" onclick="openModal('modal-add')"><i class="fa-solid fa-user-plus"></i></button>
                </div>
            </div>
            
            <div class="status-bar" id="status-circles"></div>
            <div class="chat-list" id="chat-list-ui"></div>
        </div>

        <div class="main-chat">
            <div id="chat-header-ui" class="chat-header" style="display:none">
                <img src="" id="target-pic" class="avatar" onclick="handleHeaderClick()">
                <div style="flex:1" onclick="handleHeaderClick()">
                    <h4 id="target-name">Nome</h4>
                    <small id="target-info" style="color:var(--text-dim)">Clique para ver info</small>
                </div>
                <button id="delete-chat-btn" class="icon-btn hidden" onclick="deleteGroup()" style="color:var(--danger)"><i class="fa-solid fa-trash"></i></button>
                <button class="icon-btn" onclick="closeChat()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="group-admin-panel">
                <h4>Gerenciar Grupo</h4>
                <div style="display:flex; gap:10px; margin: 10px 0;">
                    <input type="text" id="edit-g-name" placeholder="Nome do Grupo" style="flex:1; padding:8px; background:#111; color:white; border:none">
                    <button onclick="saveGroupName()" class="btn-action" style="width:auto; margin:0; padding:0 15px">Ok</button>
                </div>
                <h5>Membros:</h5>
                <div id="members-list-scroll"></div>
            </div>

            <div id="messages-container"></div>
            <div class="emoji-picker" id="emoji-picker"></div>

            <div class="input-bar">
                <button class="icon-btn" onclick="toggleEmoji()"><i class="fa-regular fa-face-smile"></i></button>
                <label for="chat-file" class="icon-btn"><i class="fa-solid fa-paperclip"></i></label>
                <input type="file" id="chat-file" hidden onchange="uploadToChat(this)">
                
                <input type="text" id="msg-input" placeholder="Digite uma mensagem..." onkeypress="if(event.key==='Enter')sendText()">
                <button onclick="sendText()" class="icon-btn" style="color:var(--accent)"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-post-status" class="modal"><div class="modal-content">
        <h3>Novo Status</h3>
        <input type="text" id="status-title" placeholder="Escreva uma legenda..." style="width:100%; padding:10px; margin:10px 0; background:#111; color:white; border:none">
        <input type="file" id="status-file-input" style="color:white">
        <button class="btn-action" onclick="postStatus()">Publicar</button>
        <button class="btn-action" style="background:#444" onclick="closeModals()">Fechar</button>
    </div></div>

    <div id="modal-view-status" class="modal" onclick="closeModals()"><div class="modal-content" style="background:transparent; text-align:center" onclick="event.stopPropagation()">
        <h3 id="view-status-name" style="margin-bottom:10px"></h3>
        <img src="" id="view-status-img" style="max-width:100%; max-height:75vh; border-radius:10px; border: 2px solid var(--accent)">
        <p id="view-status-title" style="margin-top:15px; font-size:20px; font-weight:bold"></p>
    </div></div>

    <div id="modal-profile" class="modal"><div class="modal-content" style="padding:0; overflow:hidden">
        <div id="p-banner" class="p-banner"></div>
        <img src="" id="p-avatar" class="p-avatar-big">
        <div style="padding:20px">
            <h2 id="p-name">Nome</h2>
            <p id="p-bio" style="color:var(--text-dim); margin:10px 0"></p>
            <div id="edit-profile-fields" class="hidden">
                <input type="text" id="edit-name" placeholder="Nome" style="width:100%; padding:8px; margin-bottom:10px">
                <input type="text" id="edit-bio" placeholder="Bio" style="width:100%; padding:8px; margin-bottom:10px">
                <label>Foto:</label> <input type="file" onchange="updateProfileMedia(this, 'pic')"><br>
                <label>Banner:</label> <input type="file" onchange="updateProfileMedia(this, 'banner')">
                <button class="btn-action" onclick="saveProfile()">Salvar Tudo</button>
            </div>
            <button class="btn-action" style="background:#444" onclick="closeModals()">Fechar</button>
        </div>
    </div></div>

    <div id="modal-group" class="modal"><div class="modal-content">
        <h3>Criar Grupo</h3>
        <input type="text" id="g-name" placeholder="Nome do Grupo" style="width:100%; padding:10px; margin:15px 0; background:#111; color:white; border:none">
        <input type="file" id="g-pic-input" style="color:white">
        <button class="btn-action" onclick="createGroup()">Criar Agora</button>
    </div></div>

    <div id="modal-add" class="modal"><div class="modal-content">
        <h3>Adicionar Ghost por ID</h3>
        <input type="text" id="search-id" placeholder="Ex: 8842" style="width:100%; padding:10px; margin:15px 0; background:#111; color:white; border:none">
        <div id="search-res"></div>
    </div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0DhQ-EUs3Azqn7_tbB-W3S9ko0DaUWls",
            authDomain: "ghostchat-app-3a3f0.firebaseapp.com",
            projectId: "ghostchat-app-3a3f0",
            storageBucket: "ghostchat-app-3a3f0.firebasestorage.app",
            messagingSenderId: "781582052854",
            appId: "1:781582052854:web:7fba6eae2a372ce0e22bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myData = {}, activeChatId = null, currentTarget = null;

        document.getElementById('login-btn').onclick = () => signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) myData = snap.data();
                else {
                    const gid = Math.floor(1000+Math.random()*9000).toString();
                    myData = { uid: user.uid, ghostId: gid, name: `Ghost#${gid}`, pic: `https://api.dicebear.com/7.x/bottts/svg?seed=${gid}`, bio: "ðŸ‘»", banner: "" };
                    await setDoc(doc(db, "users", user.uid), myData);
                }
                document.getElementById('my-pfp').src = myData.pic;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadContacts();
                loadStatusCircles();
            }
        });

        // STATUS
        window.postStatus = () => {
            const file = document.getElementById('status-file-input').files[0];
            const title = document.getElementById('status-title').value;
            if(!file) return;
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = async () => {
                await setDoc(doc(db, "status", myData.uid), { url: r.result, title, name: myData.name, pic: myData.pic, time: Date.now() });
                closeModals();
            };
        };

        function loadStatusCircles() {
            onSnapshot(collection(db, "status"), (snap) => {
                const bar = document.getElementById('status-circles'); bar.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    const dot = document.createElement('div');
                    dot.className = 'status-dot';
                    dot.innerHTML = `<img src="${s.pic}" class="status-circle"><span class="status-name">${s.name}</span>`;
                    dot.onclick = () => {
                        document.getElementById('view-status-img').src = s.url;
                        document.getElementById('view-status-name').innerText = s.name;
                        document.getElementById('view-status-title').innerText = s.title;
                        openModal('modal-view-status');
                    };
                    bar.appendChild(dot);
                });
            });
        }

        // CHAT E MENSAGENS
        window.sendText = () => {
            const v = document.getElementById('msg-input').value;
            if(!v.trim()) return;
            sendMsg(v, 'text');
            document.getElementById('msg-input').value = "";
        };

        window.uploadToChat = (el) => {
            const file = el.files[0];
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = () => sendMsg(r.result, file.type.startsWith('image') ? 'image' : 'video');
        };

        async function sendMsg(content, type) {
            if(!activeChatId) return;
            await addDoc(collection(db, "messages"), { chatId: activeChatId, senderId: myData.uid, content, type, timestamp: serverTimestamp() });
        }

        function loadMessages() {
            const q = query(collection(db, "messages"), where("chatId", "==", activeChatId), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const cont = document.getElementById('messages-container'); cont.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data(); const isMe = m.senderId === myData.uid;
                    const div = document.createElement('div'); div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
                    if(m.type === 'text') div.innerText = m.content;
                    else if(m.type === 'image') div.innerHTML = `<img src="${m.content}" style="max-width:100%; border-radius:8px">`;
                    else if(m.type === 'video') div.innerHTML = `<video src="${m.content}" controls style="max-width:100%; border-radius:8px"></video>`;
                    cont.appendChild(div);
                });
                cont.scrollTop = cont.scrollHeight;
            });
        }

        // PERFIL E GRUPOS
        window.handleHeaderClick = () => {
            if(currentTarget.isGroup) {
                const p = document.getElementById('group-admin-panel');
                p.style.display = p.style.display === 'block' ? 'none' : 'block';
                loadGroupMembers();
            } else openProfile(false);
        };

        async function loadGroupMembers() {
            const list = document.getElementById('members-list-scroll');
            const snap = await getDocs(collection(db, "users"));
            list.innerHTML = "";
            snap.forEach(uDoc => {
                const u = uDoc.data();
                list.innerHTML += `<div class="member-item"><span>${u.name}</span> <button class="icon-btn" style="color:red" onclick="alert('X')"><i class="fa-solid fa-xmark"></i></button></div>`;
            });
        }

        window.openProfile = async (isMe) => {
            const u = isMe ? myData : (await getDoc(doc(db, "users", currentTarget.uid))).data();
            document.getElementById('p-name').innerText = u.name;
            document.getElementById('p-bio').innerText = u.bio;
            document.getElementById('p-avatar').src = u.pic;
            document.getElementById('p-banner').style.backgroundImage = u.banner ? `url(${u.banner})` : 'none';
            document.getElementById('edit-profile-fields').classList.toggle('hidden', !isMe);
            openModal('modal-profile');
        };

        window.updateProfileMedia = (el, type) => {
            const r = new FileReader(); r.readAsDataURL(el.files[0]);
            r.onload = () => { if(type==='pic') myData.pic = r.result; else myData.banner = r.result; };
        };

        window.saveProfile = async () => {
            myData.name = document.getElementById('edit-name').value || myData.name;
            myData.bio = document.getElementById('edit-bio').value || myData.bio;
            await updateDoc(doc(db, "users", myData.uid), myData);
            location.reload();
        };

        window.deleteGroup = async () => {
            if(confirm("Sair do grupo?")) {
                await deleteDoc(doc(db, "users", myData.uid, "contacts", currentTarget.uid));
                location.reload();
            }
        };

        function loadContacts() {
            onSnapshot(collection(db, "users", myData.uid, "contacts"), (snap) => {
                const ui = document.getElementById('chat-list-ui'); ui.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div'); div.className = 'chat-item';
                    div.innerHTML = `<img src="${c.pic}" class="avatar"> <b>${c.name}</b>`;
                    div.onclick = () => {
                        activeChatId = c.isGroup ? c.uid : [myData.uid, c.uid].sort().join('_');
                        currentTarget = c;
                        document.getElementById('chat-header-ui').style.display = 'flex';
                        document.getElementById('target-name').innerText = c.name;
                        document.getElementById('target-pic').src = c.pic;
                        document.getElementById('delete-chat-btn').classList.toggle('hidden', !c.isGroup);
                        loadMessages();
                    };
                    ui.appendChild(div);
                });
            });
        }

        window.createGroup = async () => {
            const name = document.getElementById('g-name').value;
            const file = document.getElementById('g-pic-input').files[0];
            const gId = "group_" + Date.now();
            const create = (pic) => {
                setDoc(doc(db, "users", myData.uid, "contacts", gId), { uid: gId, name, pic, isGroup: true });
                closeModals();
            };
            if(file) { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => create(r.result); }
            else create('https://cdn-icons-png.flaticon.com/512/615/615075.png');
        };

        document.getElementById('search-id').oninput = async (e) => {
            const q = query(collection(db, "users"), where("ghostId", "==", e.target.value));
            const snap = await getDocs(q);
            const res = document.getElementById('search-res'); res.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                res.innerHTML = `<button class="btn-action" onclick="saveContact('${u.uid}','${u.name}','${u.pic}')">Add ${u.name}</button>`;
            });
        };

        window.saveContact = async (uid, name, pic) => {
            await setDoc(doc(db, "users", myData.uid, "contacts", uid), { uid, name, pic, isGroup: false });
            closeModals();
        };

        window.openModal = id => document.getElementById(id).style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        window.toggleEmoji = () => { const p = document.getElementById('emoji-picker'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; };
        const emojis = "ðŸ˜€ðŸ˜ƒðŸ˜„ðŸ˜ðŸ˜†ðŸ˜…ðŸ˜‚ðŸ¤£ðŸ˜ŠðŸ˜‡ðŸ™‚ðŸ™ƒðŸ˜‰ðŸ˜ŒðŸ˜ðŸ¥°ðŸ˜˜ðŸ˜—ðŸ˜™ðŸ˜šðŸ˜‹ðŸ˜›ðŸ˜œðŸ¤ªðŸ˜ðŸ¤‘ðŸ¤—ðŸ¤­ðŸ¤«ðŸ¤”ðŸ˜ðŸ˜‘ðŸ˜¶ðŸ˜ðŸ˜’ðŸ™„ðŸ˜¬ðŸ¤¥ðŸ˜ŒðŸ˜”ðŸ˜ªðŸ¤¤ðŸ˜´ðŸ˜·ðŸ¤’ðŸ¤•ðŸ¤¢ðŸ¤®ðŸ¤§ðŸ˜µðŸ¤¯ðŸ¤ ðŸ¥³ðŸ˜ŽðŸ¤“ðŸ§ðŸ˜•ðŸ˜ŸðŸ™â˜¹ï¸ðŸ˜®ðŸ˜¯ðŸ˜²ðŸ˜³ðŸ¥ºðŸ˜¦ðŸ˜§ðŸ˜¨ðŸ˜°ðŸ˜¥ðŸ˜¢ðŸ˜­ðŸ˜¤ðŸ˜ ðŸ˜¡ðŸ¤¬ðŸ˜ˆðŸ‘¿ðŸ’€â˜ ï¸ðŸ‘»ðŸ‘½ðŸ¤–";
        [...emojis].forEach(e => { const s = document.createElement('span'); s.innerText = e; s.onclick = () => document.getElementById('msg-input').value += e; document.getElementById('emoji-picker').appendChild(s); });
    </script>
</body>
</html>
