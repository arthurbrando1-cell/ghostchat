<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // SUBSTITUA PELOS DADOS DO SEU PROJETO NO FIREBASE CONSOLE
    const firebaseConfig = {
        apiKey: "SUA_API_KEY",
        authDomain: "SEU_PROJETO.firebaseapp.com",
        projectId: "SEU_PROJETO",
        storageBucket: "SEU_PROJETO.appspot.com",
        messagingSenderId: "SEU_SENDER_ID",
        appId: "SEU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ID FIXO DA CONVERSA (Todas as mensagens vão para esta "sala")
    const CHAT_ID = "global_chat_room"; 
    const messagesRef = collection(db, "chats", CHAT_ID, "messages");

    let currentUser = localStorage.getItem('whatsapp_user');
    let currentUserId = localStorage.getItem('whatsapp_uid');

    // Se não houver ID, gera um fixo para este navegador
    if (!currentUserId) {
        currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('whatsapp_uid', currentUserId);
    }

    const loginModal = document.getElementById('login-modal');
    const appContainer = document.getElementById('app-container');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages-container');

    // Função de Login
    window.login = function() {
        const name = document.getElementById('username-input').value.trim();
        if (name) {
            currentUser = name;
            localStorage.setItem('whatsapp_user', name);
            showApp();
        }
    }

    function showApp() {
        loginModal.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.classList.add('flex');
        document.getElementById('my-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser)}&background=00a884&color=fff`;
        listenMessages();
    }

    // ENVIO EM TEMPO REAL
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        messageInput.value = ''; // Limpa o input na hora para feedback rápido
        
        try {
            await addDoc(messagesRef, {
                text: text,
                user: currentUser,
                uid: currentUserId,
                createdAt: serverTimestamp() // Hora do servidor (crucial para sincronia)
            });
        } catch (e) {
            console.error("Erro ao enviar:", e);
        }
    }

    // ESCUTA EM TEMPO REAL (O "Coração" do sistema)
    function listenMessages() {
        const q = query(messagesRef, orderBy("createdAt", "asc"));
        
        // Esta função roda toda vez que alguém (você ou o outro) manda mensagem
        onSnapshot(q, (snapshot) => {
            messagesContainer.innerHTML = ''; // Limpa e redesenha (ou você pode fazer append)
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                renderMessage(data);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }

    function renderMessage(data) {
        const isMe = data.uid === currentUserId;
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex mb-2 ${isMe ? 'justify-end' : 'justify-start'}`;
        
        const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
        const bubbleClass = isMe ? 'message-out' : 'message-in';
        
        msgDiv.innerHTML = `
            <div class="${bubbleClass} relative max-w-[65%] px-2 py-1 shadow-sm text-sm" style="position: relative;">
                ${!isMe ? `<div class="text-[#d75e47] text-[11px] font-bold mb-1">${data.user}</div>` : ''}
                <div class="flex flex-col">
                    <span class="text-[#111b21] pb-1 pr-10">${escapeHtml(data.text)}</span>
                    <div class="text-[10px] text-[#667781] self-end">${time}</div>
                </div>
            </div>
        `;
        messagesContainer.appendChild(msgDiv);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Listeners
    document.getElementById('login-btn').onclick = login;
    document.getElementById('send-btn').onclick = sendMessage;
    messageInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    if (currentUser) showApp();
</script>
